-- 6. Populate the final_league_summary_json table (Hive 3.1.3 compatible, no UDF)
INSERT OVERWRITE TABLE final_league_summary_json
SELECT
    league_aggs.league,
    league_aggs.total_matches,
    league_aggs.avg_goals_per_match,
    -- Construct the JSON array directly using built-in functions compatible with Hive 3.1.3
    '[' || CONCAT_WS(',', COLLECT_LIST(ranked_teams.team_rank_json_string)) || ']' AS teams_ranking
FROM (
    -- Calculate league-level aggregates: total_matches, avg_goals_per_match
    SELECT
        t.league,
        SUM(m.matches_played) AS total_matches,
        SUM(m.total_goals_scored_for_team_season) / SUM(m.matches_played) AS avg_goals_per_match
    FROM mr_output_orc m
    JOIN teams_orc t ON m.team_id = t.team_id
    GROUP BY t.league
) league_aggs
JOIN (
    -- Calculate team rankings and prepare the array of JSON strings
    SELECT
        league,
        -- Manually construct the JSON string for each team's rank
        CONCAT(
            '{"team_id":"', team_id,
            '","rank_in_league":', CAST(team_rank AS STRING), '}'
        ) AS team_rank_json_string
    FROM (
        SELECT
            m.team_id,
            t.league,
            m.matches_played,
            ROW_NUMBER() OVER (PARTITION BY t.league ORDER BY m.matches_played DESC) AS team_rank
        FROM mr_output_orc m
        JOIN teams_orc t ON m.team_id = t.team_id
    ) ranked_teams_base
) ranked_teams ON league_aggs.league = ranked_teams.league
GROUP BY
    league_aggs.league,
    league_aggs.total_matches,
    league_aggs.avg_goals_per_match;